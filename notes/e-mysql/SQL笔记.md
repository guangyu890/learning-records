# SQL笔记

* 目标：熟悉使用SQL语句对关系型数据库进行查、改、增、删操作，利用所有知识根据业务场景创建数据库。
* 参考：廖雪峰的官方网站、菜鸟教程。

***

## 一、数据类型

对于一个关系表，除了定义每一列的名称外，还需定义每一列的数据类型，以下是关系数据库支持的标准数据类型：

| 名称            | 类型       | 说明                                                         |
| --------------- | ---------- | ------------------------------------------------------------ |
| INT             | 整型       | 4个字节整数类型，约为正负21亿                                |
| BIGINT          | 长整型     | 8个字节整数类型，约922亿亿                                   |
| REAL（FLOAT）   | 浮点型     | 4字节浮点数                                                  |
| DOUBLE          | 浮点型     | 8字节浮点数                                                  |
| DECIMAL（M，N） | 高数度小数 | DECIMAL（20,10）表示一共20位，其中小数10位，通常用于财务计算 |
| CHAR（N）       | 定长字符串 | CHAR（100）总是存储100个字符的字符串                         |
| VARCHAR（N）    | 变长字符串 | VARCHAR（100）可以存储0～100个字符的字符串                   |
| BOOLEAN         | 布尔类型   | 存储True或False                                              |
| DATE            | 日期类型   | 存储日期，如：2018-06-22                                     |
| TIME            | 时间类型   | 存储时间。如：12：20：59                                     |
| DATETIME        | 日期类型   | 存储日期+时间，例如：2018-06-22 12：20：59                   |

BIGINT能满足整数存储的需求，VARCHAR能满足字符串存储的需求。

SQL语言关键字不区分大小写，SQL一般约定关键字总是大写，以示突出，表名和列名均使用小写。

***

## 二、关系模型

关系型数据库是建立在关系模型上的，而关系模型本质上是若干个存储数据的二维表，可以把它看成很多EXCEL表。

* 表的每一行称为记录（Record），记录是一个逻辑意义上的数据。
* 表的每一列称为字段（Column），同一个表的每一行记录都拥有相同的若干字段。字段定义了数据类型，以及是否允许为NULL。NUll表示字段数据不存在。一个整型字段如果为NULL不表示它的值为0，同理，一个字符串型字段为NULL也不表示它的值为空串''。通常情况下，字段应避免允许为NULL，不允许为NULL可以简化查询，也利于应用程序读取数据后无需判断是否为NULL。

和EXCEL表不同的是，关系数据库的表与表之间需要建立“一对多”，“多对一”和“一对一”的关系。在关系型数据库中，关系是通过主键和外键来维护的。

***

### （一）主键。

* 每一条记录都包含若干定义好的字段，同一个表的所有记录都有相同的字段定义。

* 对于关系表，有个很重要的约束，就是任意两条记录不能重复，不能重复不是指两条记录不完全相同，而是指能够通过某个字段唯一区分出不同的记录，这个字段被称为主键。
* 对于主键的要求：记录一旦插入到表中，主键最好不要再修改，因为主键是用来唯一定位的记录，修改了主键，会造成一系列的影响。所以，选取主键的一个基本原则是：不使用任何业务相关的字段作为主键。因此，身份证号码、手机号码和邮箱地址这些看上去可以唯一的字段，均不可以用作主键。主键最好是与业务完全无关的字段，一般这个字段名称为ID，ID字段类型有：
  * 自增整数类型。数据库会在插入数据时自动为每一条记录分配一个自增整数，这样我们就完全不用担心主键重复，也不用自己预先生成主键；字段定义：BIGINT NOT NULL AUTO_INCREMENT。
  * 全局唯一GUID类型。通过MAC地址，时间戳和随机数保证任意计算机在任意时间生成的字符串都是不同的。

***

### （二）联合主键

* 关系型数据库实际上允许通过多个字段唯一标识记录，即两个或更多的字段都设置为主键，这种主键被称为联合主键。对于联合主键，允许一列有重复，只要不是所有的主键列都重复即可，一般不建议使用联合主键。

小结：主键是关系表中记录的唯一标识，主键的选取非常重要，主键不要带有业务含义，而应该使用BIGINT自增或都 GUID类型。主键也不允许为NULL。可以使用多个列作为联合主键，但联合主键并不常用。

***

### （三）外键

* 通过某个字段把数据与另一张表关联起来，这种列称为外键。外键并不是通过列名实现的，而是通过定义外键约束实现的：

  ```sql
  ALTER TABLE students,
  ADD CONSTRAINT fk_class_id,
  FOREIGN KEY(class_id),
  REFERENCES class(id),
  ```

  其中，外键约束的名称fk_class_id可以任意，FOREIGN KEY（class_id）指定了class_id作为外键，REFERENCES class(id)指定了这个外键将关联到classes表的id列（即classes表的外键）。

* 删除外键的方法。

  ```sql
  ALTER TABLE students
  DROP FOREIGN fk_class_id;
  --删除外键约束并没有删除外键这一列，删除列通过DROP COLUMN...实现。
  ```

***

### （四）多对多

* 通过一个表的外键关联到另一个表，可以定义出一对多关系，有时还需多对多关系。如一个老师可以对应多个班级，一个班级也可以对应多个老师，因此，班级表和老师表存在多对多的关系，多对多关系实际上是通过两个一对多关系实现的，即通过一个中间表，关联两个一对多关系，就形成了多对多关系。e.g:
* teachers_tbl

| id   | name   |
| ---- | ------ |
| 1    | 娄老师 |
| 2    | 陆老师 |
| 3    | 马老师 |

* classes_tbl

| id   | name |
| ---- | ---- |
| 1    | 一班 |
| 2    | 二班 |

* 中间表teacher_class关联两个一对多关系

| id   | teacher_id | class_id |
| ---- | ---------- | -------- |
| 1    | 1          | 1        |
| 2    | 1          | 2        |
| 3    | 2          | 1        |
| 4    | 2          | 2        |
| 5    | 3          | 1        |
| 6    | 4          | 2        |

通过中间teacher_class可知teachers到classes的关系，通过中间表，我们定义了一个多对多的关系。

***

### （五）一对一

* 一对一关系是指一个表的记录对应到另一个表的唯一一个记录。如：students表的每个学生可以有自己的联系方式，如果把联系方式存入另一个表contacts，我们就可以得到一个"一对一"关系。如果业务允许，完全可以把两个表合为一个表，但是，有时候，如果某个学生没有手机号码，那么，contacts表就不存在对应的记录，实际上，一对一关系准确说，是contacts表一对一对应students表。

小结：关系数据库通过外键可以实现一对多、多对多和一对一的关系，外键可以通过数据库来约束，也可以不设置约束，仅靠应用程序的逻辑来保证。

***

### （六）索引

* 索引是关系数据库中的表对某一列或多个列的值进行预排序的数据结构。通过使用索引，可以让数据库系统不必扫描整个表，而是直接定位到符合条件的记录，这样就大大加快了查询速度。e.g:

```sql
ALTER TABLE students
ADD INDEX idx_name_score(score);
```

上述使用ADD INDEX idx_score(score)就创建卫个名称为idx_score，使用score的索引。索引名是任意的，索引如果有多列，可以在括号里依次写上。e.g:

```Sql
ALTER TABLE students
ADD INDEX idx_name_score(name, score);
```

索引的效率取决于索引列的值是否散列，即该列的值如果越互不相同，那么索引效率越高，反过来，如果记录的列存在大量的相同的值，如性别各占一半，因此，对该列创建索引就没有意义。

可以对一张表创建多个索引，索引的优点是提高了查询效率，缺点是在插入、更新和删除记录时，需要同时修改索引，因此，索引越多，插入、更新和删除记录的速度就越慢。

对于主键，关系数据库会自动对其创建主键索引，使用主键索引的效率是最高的，因为主键会保证绝对唯一。

***

### （七）唯一索引

在关系表中，看上去唯一的列，因含有业务逻辑，因此不宜作为主键。

但是这些列根据业务要求，以又具有唯一性约束，即不能出现两条记录存储了同一个身份证号码，这个时候就可以给该列添加一个唯一索引。方法如下：

```sql
ALTER TABLE students
ADD UNIQUE INDEX uni_name(ID_card)
```

通过UNIQUE关键字我们就添加了一个唯一索引。也可以只对某一列添加一个唯一约束而不是创建唯一索引。方法如下：

```sql
ALTER TABLE students
ADD CONSTRAINT uni_name UNIQUE（ID_card）;
```

这种情况下，ID_card列没有索引，但仍然具有唯一性保证。

小结：

* 通过对数据库表创建索引，可以提高查询速度
* 通过创建唯一索引，可以保证某一列的值具有唯一性
* 数据库索引对于用户和应用程序来说都是透明的

***

## 三、查询数据

* 查看表结构。

  ```sql
  --通过SHOW关键字查看表的结构（字段名称）
  SHOW COLUMNS FROM table_name;
  --修改表的字段
  ALTER TABLE table_name CHANGE 旧字段名 新字段名 新数据类型;
  ```

  